"""
Представления (Views) Django для приложения greeting_app.

Представления - это функции или классы, которые обрабатывают HTTP запросы
и возвращают HTTP ответы. Они связывают модели, формы и шаблоны вместе.
"""

from django.shortcuts import render, redirect
from django.contrib import messages
from .models import UserName
from .forms import NameForm


def home(request):
    """
    Представление для главной страницы приложения.
    
    Эта функция:
    1. Обрабатывает GET запросы - отображает форму для ввода имени
    2. Обрабатывает POST запросы - сохраняет имя в БД и показывает приветствие
    
    Args:
        request: HTTP запрос от пользователя
        
    Returns:
        HTTP ответ с отрендеренным HTML шаблоном
    """
    
    # Получение последнего сохраненного имени из базы данных
    # order_by('-created_at') - сортировка по дате создания (от новых к старым)
    # [:1] - получение только первой записи (последней по дате)
    # first() - получение объекта или None, если записей нет
    # Используем try-except для обработки возможных ошибок БД
    try:
        last_name = UserName.objects.order_by('-created_at').first()
    except Exception:
        # В случае ошибки (например, таблица еще не создана) устанавливаем None
        # Это позволяет приложению работать даже если миграции не применены
        last_name = None
    
    # Проверка метода HTTP запроса
    if request.method == 'POST':
        # Если запрос POST - пользователь отправил форму
        
        # Создание экземпляра формы с данными из запроса
        # request.POST содержит данные, отправленные через форму
        form = NameForm(request.POST)
        
        # Проверка валидности формы
        # is_valid() проверяет все правила валидации, определенные в форме
        if form.is_valid():
            # Если форма валидна, сохраняем данные в базу данных
            # save() создает новую запись в таблице UserName
            saved_name = form.save()
            
            # Добавление сообщения об успешном сохранении
            # messages - система сообщений Django для отображения уведомлений пользователю
            messages.success(
                request,
                f'Привет, {saved_name.name}! Ваше имя успешно сохранено.'
            )
            
            # Перенаправление на главную страницу
            # redirect('greeting_app:home') перенаправляет на URL с именем 'home'
            # в пространстве имен 'greeting_app' (определено в urls.py)
            # Это предотвращает повторную отправку формы при обновлении страницы
            return redirect('greeting_app:home')
        else:
            # Если форма невалидна (например, пустое поле)
            # Ошибки валидации автоматически добавляются в form.errors
            # Эти ошибки будут отображены в шаблоне
            messages.error(
                request,
                'Пожалуйста, исправьте ошибки в форме.'
            )
    else:
        # Если запрос GET - пользователь просто открыл страницу
        # Создаем пустую форму для отображения
        form = NameForm()
    
    # Подготовка контекста для передачи в шаблон
    # Контекст - это словарь с данными, которые будут доступны в HTML шаблоне
    context = {
        'form': form,              # Форма для ввода имени
        'last_name': last_name,    # Последнее сохраненное имя (для приветствия)
    }
    
    # Рендеринг HTML шаблона с контекстом
    # 'greeting_app/home.html' - путь к шаблону
    # context - данные для использования в шаблоне
    # Возвращает HTTP ответ с HTML страницей
    return render(request, 'greeting_app/home.html', context)

